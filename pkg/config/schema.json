{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "properties": {
    "organization": {
      "$ref": "#/definitions/root.organization"
    },
    "discovery": {
      "$ref": "#/definitions/root.discovery"
    },
    "storage": {
      "type": "object",
      "properties": {
        "batch_size": {
          "type": "integer",
          "minimum": 1
        },
        "engines": {
          "type": "object",
          "properties": {
            "postgresql": {
              "type": "object",
              "properties": {
                "host": {
                  "type": "string"
                },
                "port": {
                  "type": "integer"
                },
                "user": {
                  "type": "string"
                },
                "password": {
                  "type": "string"
                },
                "db": {
                  "type": "string"
                }
              },
              "required": ["host", "port", "user", "password", "db"]
            },
            "neo4j": {
              "type": "object",
              "properties": {
                "config_key": {
                  "type": "string"
                }
              },
              "required": ["config_key"]
            }
          },
          "anyOf": [
            { "required": ["postgresql"] },
            { "required": ["neo4j"] }
          ]
        },
        "default_engine": {
          "type": "string"
        }
      },
      "required": ["batch_size", "engines", "default_engine"]
    },
    "source": {
      "type": "object",
      "additionalProperties": false,
      "patternProperties": {
        ".*": {
          "oneOf": [
            { "$ref": "#/definitions/source.aws_ec2" },
            { "$ref": "#/definitions/source.aws_ecr" },
            { "$ref": "#/definitions/source.aws_rds" },
            { "$ref": "#/definitions/source.aws_s3" },
            { "$ref": "#/definitions/source.file_system" },
            { "$ref": "#/definitions/source.github_repository" }
          ]
        }
      }
    },
    "relations": {
      "type": "object",
      "properties": {
        "criteria": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": { "type": "string" },
              "source": {
                "type": "object",
                "properties": {
                  "kind": { "type": "string" },
                  "meta_key": { "type": "string" },
                  "meta_value": { "type": "string" }
                },
                "required": ["kind", "meta_key", "meta_value"]
              },
              "target": {
                "type": "object",
                "properties": {
                  "kind": { "type": "string" },
                  "meta_key": { "type": "string" },
                  "meta_value": { "type": "string" }
                },
                "required": ["kind", "meta_key", "meta_value"]
              }
            },
            "required": ["name", "source", "target"]
          }
        }
      }
    }
  },
  "required": ["organization", "discovery", "storage", "source", "relations"],
  "definitions": {
    "root.organization": {
      "type": "object",
      "properties": {
        "logo": {
          "type": "string"
        },
        "name": {
          "type": "string"
        }
      },
      "required": ["type", "configuration"]
    },
    "root.discovery": {
      "type": "object",
      "properties": {
        "name": { "type": "string" },
        "description": { "type": "string" },
        "worker_pool_size": { "type": "integer" }
      },
      "required": [
        "name",
        "description",
        "worker_pool_size"
      ]
    },
    "source.file_system": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["file_system"]
        },
        "configuration": {
          "$ref": "#/definitions/source.file_system.configuration"
        }
      },
      "required": ["type", "configuration"]
    },
    "source.file_system.configuration": {
      "type": "object",
      "properties": {
        "root_directory": {
          "type": "string"
        }
      },
      "required": ["root_directory"]
    },
    "source.github_repository": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["github_repository"]
        },
        "configuration": {
          "$ref": "#/definitions/source.github_repository.configuration"
        }
      },
      "required": ["type", "configuration"]
    },
    "source.github_repository.configuration": {
      "type": "object",
      "properties": {
        "user_or_org": {
          "type": "string"
        },
        "token": {
          "type": "string"
        }
      },
      "required": ["user_or_org", "token"]
    },
    "source.aws_s3": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["aws_s3"]
        },
        "configuration": {
          "$ref": "#/definitions/source.aws_common.configuration"
        }
      },
      "required": ["type", "configuration"]
    },
    "source.aws_rds": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["aws_rds"]
        },
        "configuration": {
          "$ref": "#/definitions/source.aws_common.configuration"
        }
      },
      "required": ["type", "configuration"]
    },
    "source.aws_ec2": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["aws_ec2"]
        },
        "configuration": {
          "$ref": "#/definitions/source.aws_common.configuration"
        }
      },
      "required": ["type", "configuration"]
    },
    "source.aws_ecr": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["aws_ecr"]
        },
        "configuration": {
          "$ref": "#/definitions/source.aws_common.configuration"
        }
      },
      "required": ["type", "configuration"]
    },
    "source.aws_common.configuration": {
      "type": "object",
      "properties": {
        "access_key": {
          "type": "string"
        },
        "secret_key": {
          "type": "string"
        },
        "session_token": {
          "type": "string"
        },
        "region": {
          "type": "string"
        },
        "account_id": {
          "type": "string"
        }
      },
      "required": ["access_key", "secret_key", "session_token", "region", "account_id"]
    }
  }
}